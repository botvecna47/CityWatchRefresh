// CityWatch Database Schema
// Designed for civic accountability platform with full audit trail

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// USER & AUTHENTICATION
// ============================================================================

model User {
  id                String    @id @default(cuid())
  phone             String    @unique
  isPhoneVerified   Boolean   @default(false)
  name              String
  email             String?   @unique
  passwordHash      String
  
  // Role-based access
  role              UserRole  @default(CITIZEN)
  
  // Verification status for Verified Contributors
  isVerified        Boolean   @default(false)
  verificationDoc   String?   // Path to uploaded ID document
  verifiedAt        DateTime?
  verifiedBy        String?   // Admin who verified
  
  // Reputation system
  credibilityScore  Int       @default(50)
  
  // Account status
  isActive          Boolean   @default(true)
  isSuspended       Boolean   @default(false)
  suspendedAt       DateTime?
  suspendedReason   String?
  suspendedBy       String?
  
  // Timestamps
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  lastLoginAt       DateTime?
  
  // Relations
  issues            Issue[]   @relation("ReportedBy")
  moderatedIssues   Issue[]   @relation("ModeratedBy")
  statusUpdates     IssueStatusUpdate[]
  auditLogs         AuditLog[]
  notifications     Notification[]
  
  // City/Ward assignment (for moderators)
  assignedCityId    String?
  assignedCity      City?     @relation(fields: [assignedCityId], references: [id])

  @@index([phone])
  @@index([role])
  @@index([credibilityScore])
}

enum UserRole {
  CITIZEN
  VERIFIED_CONTRIBUTOR
  MODERATOR
  CITY_ADMIN
  AUTHORITY
  SUPER_ADMIN
}

// ============================================================================
// GEOGRAPHY - City/Ward Structure
// ============================================================================

model State {
  id        String   @id @default(cuid())
  name      String   @unique
  code      String   @unique // e.g., "MH" for Maharashtra
  cities    City[]
  createdAt DateTime @default(now())
}

model City {
  id        String   @id @default(cuid())
  name      String
  stateId   String
  state     State    @relation(fields: [stateId], references: [id])
  
  // City status
  isActive  Boolean  @default(false) // Only active for pilot cities
  pilotStartDate DateTime?
  
  wards     Ward[]
  issues    Issue[]
  users     User[]
  departments Department[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([name, stateId])
  @@index([isActive])
}

model Ward {
  id        String   @id @default(cuid())
  name      String
  number    String?  // Ward number if applicable
  cityId    String
  city      City     @relation(fields: [cityId], references: [id])
  
  issues    Issue[]
  
  createdAt DateTime @default(now())

  @@unique([name, cityId])
}

// ============================================================================
// DEPARTMENTS - Government departments responsible for issues
// ============================================================================

model Department {
  id          String   @id @default(cuid())
  name        String
  code        String   // e.g., "PWD", "SWACH"
  description String?
  cityId      String
  city        City     @relation(fields: [cityId], references: [id])
  
  // Contact info for escalation
  contactEmail String?
  contactPhone String?
  
  issues      Issue[]
  
  createdAt   DateTime @default(now())

  @@unique([code, cityId])
}

// ============================================================================
// ISSUE CATEGORIES - Strict taxonomy
// ============================================================================

model Category {
  id          String   @id @default(cuid())
  name        String   @unique
  slug        String   @unique
  description String?
  icon        String?  // Icon identifier
  isActive    Boolean  @default(true)
  sortOrder   Int      @default(0)
  
  issues      Issue[]
  
  createdAt   DateTime @default(now())
}

// ============================================================================
// ISSUES - Core entity
// ============================================================================

model Issue {
  id              String      @id @default(cuid())
  
  // Issue content
  title           String      @db.VarChar(200)
  description     String      @db.Text
  
  // Location
  cityId          String
  city            City        @relation(fields: [cityId], references: [id])
  wardId          String?
  ward            Ward?       @relation(fields: [wardId], references: [id])
  latitude        Float?
  longitude       Float?
  address         String?     // Human-readable address
  
  // Classification
  categoryId      String
  category        Category    @relation(fields: [categoryId], references: [id])
  departmentId    String?
  department      Department? @relation(fields: [departmentId], references: [id])
  
  // Status lifecycle
  status          IssueStatus @default(REPORTED)
  severity        IssueSeverity @default(MEDIUM)
  
  // Moderation
  isVerified      Boolean     @default(false)
  verifiedAt      DateTime?
  moderatorId     String?
  moderator       User?       @relation("ModeratedBy", fields: [moderatorId], references: [id])
  moderatorNotes  String?     // Internal notes
  rejectionReason String?
  
  // Reporter
  reporterId      String
  reporter        User        @relation("ReportedBy", fields: [reporterId], references: [id])
  
  // Expected outcome (what reporter wants)
  expectedOutcome String?
  
  // Resolution
  isResolved      Boolean     @default(false)
  resolvedAt      DateTime?
  resolutionNotes String?
  resolutionProof String?     // Path to resolution evidence
  
  // Tracking
  daysUnresolved  Int         @default(0) // Updated via cron/trigger
  upvoteCount     Int         @default(0)
  viewCount       Int         @default(0)
  
  // Flags
  isDuplicate     Boolean     @default(false)
  duplicateOfId   String?
  duplicateOf     Issue?      @relation("Duplicates", fields: [duplicateOfId], references: [id])
  duplicates      Issue[]     @relation("Duplicates")
  
  isFlagged       Boolean     @default(false)
  flagReason      String?
  
  // Timestamps
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  
  // Relations
  evidence        Evidence[]
  statusUpdates   IssueStatusUpdate[]
  upvotes         IssueUpvote[]
  authorityResponses AuthorityResponse[]

  @@index([status])
  @@index([cityId, status])
  @@index([categoryId])
  @@index([reporterId])
  @@index([createdAt])
  @@index([daysUnresolved])
}

enum IssueStatus {
  REPORTED
  UNDER_REVIEW
  VERIFIED
  ESCALATED
  ACTION_TAKEN
  CLOSED
  REJECTED
}

enum IssueSeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

// ============================================================================
// EVIDENCE - Media attached to issues
// ============================================================================

model Evidence {
  id          String       @id @default(cuid())
  issueId     String
  issue       Issue        @relation(fields: [issueId], references: [id], onDelete: Cascade)
  
  type        EvidenceType
  filePath    String       // Storage path
  fileName    String
  fileSize    Int          // Bytes
  mimeType    String
  
  // Metadata from file
  capturedAt  DateTime?    // From EXIF
  capturedLat Float?       // From EXIF
  capturedLng Float?       // From EXIF
  
  // Verification
  isVerified  Boolean      @default(false)
  
  createdAt   DateTime     @default(now())

  @@index([issueId])
}

enum EvidenceType {
  IMAGE
  VIDEO
  DOCUMENT
}

// ============================================================================
// ISSUE STATUS UPDATES - Timeline/history
// ============================================================================

model IssueStatusUpdate {
  id          String      @id @default(cuid())
  issueId     String
  issue       Issue       @relation(fields: [issueId], references: [id], onDelete: Cascade)
  
  fromStatus  IssueStatus?
  toStatus    IssueStatus
  
  // Who made the change
  userId      String
  user        User        @relation(fields: [userId], references: [id])
  userRole    UserRole
  
  // Details
  reason      String?     // Why status changed
  notes       String?     // Additional notes
  isPublic    Boolean     @default(true) // Visible to public?
  
  createdAt   DateTime    @default(now())

  @@index([issueId])
  @@index([createdAt])
}

// ============================================================================
// AUTHORITY RESPONSES - Official government responses
// ============================================================================

model AuthorityResponse {
  id          String   @id @default(cuid())
  issueId     String
  issue       Issue    @relation(fields: [issueId], references: [id], onDelete: Cascade)
  
  // Responder
  authorityId String
  authorityName String
  departmentName String?
  
  // Response content
  message     String   @db.Text
  
  // Evidence of action
  proofPath   String?  // Path to proof image/document
  
  // Action taken
  actionTaken String?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([issueId])
}

// ============================================================================
// UPVOTES - Limited endorsement
// ============================================================================

model IssueUpvote {
  id        String   @id @default(cuid())
  issueId   String
  issue     Issue    @relation(fields: [issueId], references: [id], onDelete: Cascade)
  userId    String
  
  createdAt DateTime @default(now())

  @@unique([issueId, userId])
}

// ============================================================================
// AUDIT LOG - Immutable action history (CRITICAL FOR LEGAL)
// ============================================================================

model AuditLog {
  id          String     @id @default(cuid())
  
  // Actor
  userId      String?
  user        User?      @relation(fields: [userId], references: [id])
  userRole    UserRole?
  ipAddress   String?
  userAgent   String?
  
  // Action
  action      AuditAction
  entityType  String      // "Issue", "User", etc.
  entityId    String
  
  // Changes
  oldValue    Json?       // Previous state
  newValue    Json?       // New state
  
  // Context
  reason      String?     // Why action was taken
  
  createdAt   DateTime    @default(now())

  @@index([userId])
  @@index([entityType, entityId])
  @@index([action])
  @@index([createdAt])
}

enum AuditAction {
  USER_REGISTER
  USER_LOGIN
  USER_LOGOUT
  USER_UPDATE
  USER_VERIFY
  USER_SUSPEND
  USER_UNSUSPEND
  ISSUE_CREATE
  ISSUE_UPDATE
  ISSUE_VERIFY
  ISSUE_REJECT
  ISSUE_ESCALATE
  ISSUE_RESOLVE
  ISSUE_CLOSE
  ISSUE_FLAG
  ISSUE_MERGE
  MODERATOR_ASSIGN
  MODERATOR_REMOVE
  SYSTEM_CLEANUP
  SYSTEM_BACKUP
}

// ============================================================================
// NOTIFICATIONS
// ============================================================================

model Notification {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  type      NotificationType
  title     String
  message   String
  
  // Reference to related entity
  entityType String?
  entityId   String?
  
  isRead    Boolean  @default(false)
  readAt    DateTime?
  
  createdAt DateTime @default(now())

  @@index([userId, isRead])
  @@index([createdAt])
}

enum NotificationType {
  ISSUE_STATUS_CHANGE
  ISSUE_VERIFIED
  ISSUE_REJECTED
  ISSUE_RESOLVED
  AUTHORITY_RESPONSE
  ACCOUNT_VERIFIED
  ACCOUNT_SUSPENDED
  CREDIBILITY_CHANGE
}

// ============================================================================
// OTP VERIFICATION
// ============================================================================

model OtpVerification {
  id        String   @id @default(cuid())
  phone     String
  otp       String
  purpose   OtpPurpose
  
  isUsed    Boolean  @default(false)
  attempts  Int      @default(0)
  maxAttempts Int    @default(3)
  
  expiresAt DateTime
  verifiedAt DateTime?
  
  createdAt DateTime @default(now())

  @@index([phone, purpose])
  @@index([expiresAt])
}

enum OtpPurpose {
  REGISTRATION
  LOGIN
  PASSWORD_RESET
  PHONE_CHANGE
  PHONE_VERIFICATION
}

// ============================================================================
// RATE LIMITING & ABUSE PREVENTION
// ============================================================================

model RateLimit {
  id        String   @id @default(cuid())
  key       String   @unique // e.g., "ip:192.168.1.1" or "user:abc123"
  action    String   // e.g., "issue_create", "login"
  count     Int      @default(0)
  windowStart DateTime
  
  @@index([key, action])
}

model BlockedEntity {
  id        String   @id @default(cuid())
  type      BlockType
  value     String   // IP, phone, etc.
  reason    String
  
  blockedAt DateTime @default(now())
  expiresAt DateTime?
  
  blockedBy String
  
  @@unique([type, value])
}

enum BlockType {
  IP_ADDRESS
  PHONE_NUMBER
  EMAIL
  DEVICE_ID
}
